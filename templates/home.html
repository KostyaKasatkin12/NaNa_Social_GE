<!DOCTYPE html>
<html lang="en" class="w-full h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome, {{ username }}</title>
    <!-- Tailwind CSS Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
        };
    </script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SocketIO CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <!-- Google Fonts (Poppins) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen font-poppins w-full h-full text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <div class="max-w-4xl mx-auto p-4 sm:p-6">
        <header class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold leading-relaxed">Welcome, {{ username }}</h1>
        </header>

        <main class="flex flex-col md:flex-row gap-8 min-h-[calc(100vh-200px)]">
            <!-- Left Sidebar (Friends and Friend Requests) -->
            <div class="w-full md:w-1/3 flex flex-col gap-6 md:flex-1">
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition flex-1">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2">
                        <i class="fas fa-users text-blue-500 dark:text-blue-400"></i> Your Friends
                    </h2>
                    {% if friends %}
                        <ul class="space-y-3 friend-list">
                            {% for friend in friends %}
                                <li class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-blue-500 dark:text-blue-400"></i>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <a href="{{ url_for('profile', user_id=friend[1]) }}" class="text-blue-500 dark:text-blue-400 hover:underline font-medium">{{ friend[0] }}</a>
                                        <a href="{{ url_for('create_chat', friend_id=friend[1]) }}" class="text-blue-500 dark:text-blue-400 hover:underline font-medium">Chat</a>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-gray-500 dark:text-gray-400 italic">No friends yet.</p>
                    {% endif %}
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition flex-1">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2">
                        <i class="fas fa-user-plus text-blue-500 dark:text-blue-400"></i> Friend Requests
                    </h2>
                    <ul class="space-y-3 friend-requests">
                        {% if friend_requests %}
                            {% for request in friend_requests %}
                                <li class="flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700" data-sender-id="{{ request[0] }}">
                                    <span class="font-medium text-gray-700 dark:text-gray-300">{{ request[1] }}</span>
                                    <div class="flex gap-2">
                                        <form action="{{ url_for('accept_friend', friend_id=request[0]) }}" method="POST" class="inline">
                                            <button type="submit" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition min-h-12">Accept</button>
                                        </form>
                                        <form action="{{ url_for('reject_friend', friend_id=request[0]) }}" method="POST" class="inline">
                                            <button type="submit" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 hover:scale-105 transition min-h-12">Reject</button>
                                        </form>
                                    </div>
                                </li>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-500 dark:text-gray-400 italic">No friend requests.</p>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="w-full md:w-2/3 flex flex-col gap-6">
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
                            <i class="fas fa-pen text-blue-500 dark:text-blue-400"></i> Create a Post
                        </h2>
                        <a href="{{ url_for('profile') }}" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition min-h-12">Edit Profile</a>
                    </div>
                    <form method="POST" action="{{ url_for('create_post') }}" enctype="multipart/form-data" class="flex flex-col gap-4">
                        <textarea name="content" placeholder="What's on your mind?" required class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-800 dark:text-gray-200 dark:bg-gray-700 min-h-24"></textarea>
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                            Attach Image:
                            <input type="file" name="image" accept="image/*" class="block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-500 dark:file:text-blue-400 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 mt-1"/>
                        </label>
                        <button type="submit" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition min-h-12">Post</button>
                    </form>
                </div>

                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2">
                        <i class="fas fa-newspaper text-blue-500 dark:text-blue-400"></i> Posts
                    </h2>
                    <div id="posts">
                        {% for post in posts[:5] %}
                            <div class="post pb-4 mb-4 border-b border-gray-200 dark:border-gray-700" data-post-id="{{ post[0] }}">
                                <p class="text-lg font-medium"><strong>{{ post[3] }}</strong> <span class="text-gray-500 dark:text-gray-400">({{ post[2] }})</span></p>
                                <p class="text-gray-800 dark:text-gray-200 mt-1 leading-relaxed">{{ post[1] }}</p>
                                {% if post[4] %}
                                    <img src="{{ url_for('static', filename='avatars/' + post[4]) }}" alt="Post image" class="mt-4 max-w-full rounded-lg"/>
                                {% endif %}
                                <div class="flex gap-4 mt-3 items-center">
                                    <form action="{{ url_for('like_post', post_id=post[0]) }}" method="POST" class="inline">
                                        <button type="submit" class="text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition">
                                            {% if post[7] == 'like' %}Unlike{% else %}Like{% endif %}
                                        </button>
                                    </form>
                                    <span class="text-gray-500 dark:text-gray-400">{{ post[5] }} likes</span>
                                    <form action="{{ url_for('dislike_post', post_id=post[0]) }}" method="POST" class="inline">
                                        <button type="submit" class="text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition">
                                            {% if post[7] == 'dislike' %}Undislike{% else %}Dislike{% endif %}
                                        </button>
                                    </form>
                                    <span class="text-gray-500 dark:text-gray-400">{{ post[6] }} dislikes</span>
                                    <button class="comment-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition" data-post-id="{{ post[0] }}">Comment</button>
                                </div>
                                <!-- Latest Comment -->
                                {% if post[8] %}
                                    <div class="latest-comment mt-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                        <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>{{ post[8][2] }}</strong> <span class="text-gray-500 dark:text-gray-400">({{ post[8][1] }})</span></p>
                                        <p class="text-gray-700 dark:text-gray-300">{{ post[8][0] }}</p>
                                    </div>
                                {% endif %}
                                <div class="comments-section mt-4 hidden" id="comments-{{ post[0] }}">
                                    <div class="comments-list space-y-3"></div>
                                    <form class="comment-form mt-3 flex flex-col gap-3" data-post-id="{{ post[0] }}">
                                        <textarea name="comment_content" placeholder="Write a comment..." required class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-800 dark:text-gray-200 dark:bg-gray-700 min-h-20"></textarea>
                                        <button type="submit" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition">Send</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                        {% if posts|length > 5 %}
                            <div class="hidden-posts" id="hidden-posts" style="display: none;">
                                {% for post in posts[5:] %}
                                    <div class="post pb-4 mb-4 border-b border-gray-200 dark:border-gray-700" data-post-id="{{ post[0] }}">
                                        <p class="text-lg font-medium"><strong>{{ post[3] }}</strong> <span class="text-gray-500 dark:text-gray-400">({{ post[2] }})</span></p>
                                        <p class="text-gray-800 dark:text-gray-200 mt-1 leading-relaxed">{{ post[1] }}</p>
                                        {% if post[4] %}
                                            <img src="{{ url_for('static', filename='avatars/' + post[4]) }}" alt="Post image" class="mt-4 max-w-full rounded-lg"/>
                                        {% endif %}
                                        <div class="flex gap-4 mt-3 items-center">
                                            <form action="{{ url_for('like_post', post_id=post[0]) }}" method="POST" class="inline">
                                                <button type="submit" class="text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition">
                                                    {% if post[7] == 'like' %}Unlike{% else %}Like{% endif %}
                                                </button>
                                            </form>
                                            <span class="text-gray-500 dark:text-gray-400">{{ post[5] }} likes</span>
                                            <form action="{{ url_for('dislike_post', post_id=post[0]) }}" method="POST" class="inline">
                                                <button type="submit" class="text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition">
                                                    {% if post[7] == 'dislike' %}Undislike{% else %}Dislike{% endif %}
                                                </button>
                                            </form>
                                            <span class="text-gray-500 dark:text-gray-400">{{ post[6] }} dislikes</span>
                                            <button class="comment-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition" data-post-id="{{ post[0] }}">Comment</button>
                                        </div>
                                        <!-- Latest Comment -->
                                        {% if post[8] %}
                                            <div class="latest-comment mt-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>{{ post[8][2] }}</strong> <span class="text-gray-500 dark:text-gray-400">({{ post[8][1] }})</span></p>
                                                <p class="text-gray-700 dark:text-gray-300">{{ post[8][0] }}</p>
                                            </div>
                                        {% endif %}
                                        <div class="comments-section mt-4 hidden" id="comments-{{ post[0] }}">
                                            <div class="comments-list space-y-3"></div>
                                            <form class="comment-form mt-3 flex flex-col gap-3" data-post-id="{{ post[0] }}">
                                                <textarea name="comment_content" placeholder="Write a comment..." required class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-800 dark:text-gray-200 dark:bg-gray-700 min-h-20"></textarea>
                                                <button type="submit" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition">Send</button>
                                            </form>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="toggle-posts text-center p-3 bg-gray-100 dark:bg-gray-700 rounded-lg cursor-pointer text-blue-500 dark:text-blue-400 hover:bg-gray-200 dark:hover:bg-gray-600 hover:scale-105 transition" id="toggle-posts">Show more posts</div>
                        {% endif %}
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2">
                        <i class="fas fa-search text-blue-500 dark:text-blue-400"></i> Search Users
                    </h2>
                    <form method="POST" action="{{ url_for('search_user') }}" class="flex gap-3">
                        <input type="text" name="username" placeholder="Search for users..." required class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-800 dark:text-gray-200 dark:bg-gray-700"/>
                        <button type="submit" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition min-h-12">Search</button>
                    </form>
                </div>
            </div>

            <!-- Right Sidebar (Chats and Notifications) -->
            <div class="w-full md:w-1/3 flex flex-col gap-6 md:flex-1">
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition flex-1">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2">
                        <i class="fas fa-comments text-blue-500 dark:text-blue-400"></i> Chats
                    </h2>
                    <ul id="chats-list" class="space-y-3">
                        {% if chats %}
                            {% for chat in chats %}
                                <li class="flex justify-between items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition" data-chat-id="{{ chat[0] }}">
                                    <a href="{{ url_for('chat', chat_id=chat[0]) }}" class="text-blue-500 dark:text-blue-400 hover:underline font-medium">{{ chat[1] }}</a>
                                    {% if chat[2] > 0 %}
                                        <span class="bg-blue-500 dark:bg-blue-600 text-white text-xs px-2 py-1 rounded-full">{{ chat[2] }}</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-500 dark:text-gray-400 italic">No chats yet.</p>
                        {% endif %}
                    </ul>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition flex-1">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
                            <i class="fas fa-bell text-blue-500 dark:text-blue-400"></i> Notifications
                        </h2>
                        <button id="clear-notifications" class="px-4 py-2 bg-red-500 dark:bg-red-600 text-white rounded-lg hover:bg-red-600 dark:hover:bg-red-700 hover:scale-105 transition min-h-12">Clear All</button>
                    </div>
                    <ul id="notifications-list" class="space-y-3">
                        {% if notifications %}
                            {% for notification in notifications %}
                                <li class="p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                    {{ notification[0] }}
                                    {% if notification[1] %}
                                        <span class="text-gray-500 dark:text-gray-400">({{ notification[1] }})</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="p-3 text-gray-500 dark:text-gray-400 italic">No new notifications</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </main>

        <footer class="mt-8 text-center text-gray-500 dark:text-gray-400">
            <a href="{{ url_for('logout') }}" class="text-blue-500 dark:text-blue-400 hover:underline font-medium">Logout</a> | © 2025 Nana Social Network
        </footer>
    </div>

    <script>
        // Инициализация SocketIO
        const socket = io.connect(window.location.origin);
        const userId = {{ session['user_id'] | tojson }};

        // Подключение и отладка
        socket.on('connect', () => {
            console.log('Connected to SocketIO server');
            socket.emit('join_room', userId);
            console.log(`Joined user room: ${userId}`);
        });

        // Обработка ошибок подключения
        socket.on('connect_error', (error) => {
            console.error('SocketIO connection error:', error);
        });

        // Обновление уведомлений в реальном времени
        socket.on('update_notifications', function(data) {
            if (data.user_id !== userId) return;
            console.log('Received update_notifications:', data);
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '';
            if (data.notifications && data.notifications.length > 0) {
                data.notifications.forEach(notification => {
                    const li = document.createElement('li');
                    li.className = 'p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition';
                    const content = notification[0];
                    const created_at = notification[1] ? ` <span class="text-gray-500 dark:text-gray-400">(${notification[1]})</span>` : '';
                    li.innerHTML = content + created_at;
                    notificationsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.className = 'p-3 text-gray-500 dark:text-gray-400 italic';
                li.textContent = 'No new notifications';
                notificationsList.appendChild(li);
            }
        });

        // Обновление списка чатов при новом сообщении
        socket.on('new_message', function(data) {
            if (data.sender_id !== userId) {
                console.log('New message received:', data);
                const chatsList = document.getElementById('chats-list');
                const chatItem = chatsList.querySelector(`[data-chat-id="${data.chat_id}"]`);
                if (chatItem) {
                    const unreadSpan = chatItem.querySelector('span');
                    let unreadCount = unreadSpan ? parseInt(unreadSpan.textContent) + 1 : 1;
                    if (unreadSpan) {
                        unreadSpan.textContent = unreadCount;
                    } else {
                        const newSpan = document.createElement('span');
                        newSpan.className = 'bg-blue-500 dark:bg-blue-600 text-white text-xs px-2 py-1 rounded-full';
                        newSpan.textContent = unreadCount;
                        chatItem.appendChild(newSpan);
                    }
                }
            }
        });

        // Обновление списка чатов при принятии дружбы
        socket.on('friend_request_accepted', function(data) {
            console.log('Friend request accepted:', data);
            const friendRequestsList = document.querySelector('.friend-requests');
            const requestItems = friendRequestsList.getElementsByTagName('li');
            for (let item of requestItems) {
                if (item.getAttribute('data-sender-id') == data.friend_id) {
                    item.remove();
                    break;
                }
            }
            const friendsList = document.querySelector('.friend-list') || document.createElement('ul');
            if (!friendsList.className) {
                friendsList.className = 'friend-list space-y-3';
                const friendsSection = document.querySelector('.friends-section') || document.querySelector('.bg-white.dark\\:bg-gray-800').firstElementChild;
                friendsSection.appendChild(friendsList);
                document.querySelector('.friends-section p')?.remove();
            }
            const friendLi = document.createElement('li');
            friendLi.className = 'flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition';
            friendLi.innerHTML = `
                <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-blue-500 dark:text-blue-400"></i>
                </div>
                <div class="flex items-center gap-3">
                    <a href="/profile/${data.friend_id}" class="text-blue-500 dark:text-blue-400 hover:underline font-medium">${data.friend_username}</a>
                    <a href="/create_chat/${data.friend_id}" class="text-blue-500 dark:text-blue-400 hover:underline font-medium">Chat</a>
                </div>`;
            friendsList.insertBefore(friendLi, friendsList.firstChild);

            // Добавление нового чата
            const chatsList = document.getElementById('chats-list');
            const existingChat = chatsList.querySelector(`[data-chat-id]`);
            if (!existingChat || !chatsList.querySelector(`a[href="/chat/${data.chat_id}"]`)) {
                const chatLi = document.createElement('li');
                chatLi.className = 'flex justify-between items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition';
                chatLi.setAttribute('data-chat-id', data.chat_id || data.friend_id);
                chatLi.innerHTML = `
                    <a href="/chat/${data.chat_id || data.friend_id}" class="text-blue-500 dark:text-blue-400 hover:underline font-medium">${data.friend_username}</a>`;
                chatsList.insertBefore(chatLi, chatsList.firstChild);
                if (chatsList.querySelector('p')) {
                    chatsList.querySelector('p').remove();
                } else {
                    console.log('No placeholder paragraph found in chats-list');
                }
            }
        });

        // Обработка отклонения запроса на дружбу
        socket.on('friend_request_rejected', function(data) {
            console.log('Friend request rejected:', data);
            const friendRequestsList = document.querySelector('.friend-requests');
            const requestItems = friendRequestsList.getElementsByTagName('li');
            for (let item of requestItems) {
                if (item.getAttribute('data-sender-id') == data.friend_id) {
                    item.remove();
                    break;
                }
            }
        });

        // Очистка всех уведомлений
        document.getElementById('clear-notifications').addEventListener('click', () => {
            fetch('/clear_notifications', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Notifications cleared');
                    const notificationsList = document.getElementById('notifications-list');
                    notificationsList.innerHTML = '<li class="p-3 text-gray-500 dark:text-gray-400 italic">No new notifications</li>';
                } else {
                    console.error('Failed to clear notifications:', data.message);
                }
            })
            .catch(error => console.error('Error clearing notifications:', error));
        });

        // Обработка нового поста
        socket.on('new_post', function(data) {
            console.log('New post received:', data);
            const postsContainer = document.getElementById('posts');
            const postDiv = document.createElement('div');
            postDiv.className = 'post pb-4 mb-4 border-b border-gray-200 dark:border-gray-700';
            postDiv.setAttribute('data-post-id', data.id);
            postDiv.innerHTML = `
                <p class="text-lg font-medium"><strong>${data.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${data.created_at})</span></p>
                <p class="text-gray-800 dark:text-gray-200 mt-1 leading-relaxed">${data.content}</p>
                ${data.image ? `<img src="/static/avatars/${data.image}" alt="Post image" class="mt-4 max-w-full rounded-lg">` : ''}
                <div class="flex gap-4 mt-3 items-center">
                    <form action="/like_post/${data.id}" method="POST" class="inline">
                        <button type="submit" class="text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition">Like</button>
                    </form>
                    <span class="text-gray-500 dark:text-gray-400">${data.likes} likes</span>
                    <form action="/dislike_post/${data.id}" method="POST" class="inline">
                        <button type="submit" class="text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition">Dislike</button>
                    </form>
                    <span class="text-gray-500 dark:text-gray-400">${data.dislikes} dislikes</span>
                    <button class="comment-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition" data-post-id="${data.id}">Comment</button>
                </div>
                <div class="latest-comment mt-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg hidden" id="latest-comment-${data.id}"></div>
                <div class="comments-section mt-4 hidden" id="comments-${data.id}">
                    <div class="comments-list space-y-3"></div>
                    <form class="comment-form mt-3 flex flex-col gap-3" data-post-id="${data.id}">
                        <textarea name="comment_content" placeholder="Write a comment..." required class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-800 dark:text-gray-200 dark:bg-gray-700 min-h-20"></textarea>
                        <button type="submit" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition">Send</button>
                    </form>
                </div>
            `;
            postsContainer.insertBefore(postDiv, postsContainer.firstChild);

            // Добавить обработчик для новой кнопки Comment
            const newCommentBtn = postDiv.querySelector('.comment-btn');
            newCommentBtn.addEventListener('click', () => {
                const postId = newCommentBtn.getAttribute('data-post-id');
                const commentsSection = document.getElementById(`comments-${postId}`);
                const commentsList = commentsSection.querySelector('.comments-list');

                commentsSection.classList.toggle('hidden');

                if (!commentsSection.classList.contains('hidden') && !commentsList.dataset.loaded) {
                    fetch(`/get_comments/${postId}`)
                        .then(response => response.json())
                        .then(data => {
                            commentsList.innerHTML = '';
                            data.comments.forEach(comment => {
                                const commentDiv = document.createElement('div');
                                commentDiv.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                                commentDiv.innerHTML = `
                                    <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${comment.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${comment.created_at})</span></p>
                                    <p class="text-gray-700 dark:text-gray-300">${comment.content}</p>`;
                                commentsList.appendChild(commentDiv);
                            });
                            commentsList.dataset.loaded = 'true';
                        })
                        .catch(error => console.error('Error loading comments:', error));
                }
            });

            // Добавить обработчик для новой формы комментария
            const newCommentForm = postDiv.querySelector('.comment-form');
            newCommentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const postId = newCommentForm.getAttribute('data-post-id');
                const content = newCommentForm.querySelector('textarea').value;

                fetch('/add_comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ post_id: postId, content: content }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const commentsList = newCommentForm.previousElementSibling;
                            const commentDiv = document.createElement('div');
                            commentDiv.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                            commentDiv.innerHTML = `
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${data.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${data.created_at})</span></p>
                                <p class="text-gray-700 dark:text-gray-300">${content}</p>`;
                            commentsList.appendChild(commentDiv);
                            // Обновить последний комментарий
                            const latestCommentDiv = document.getElementById(`latest-comment-${postId}`);
                            latestCommentDiv.innerHTML = commentDiv.innerHTML;
                            latestCommentDiv.classList.remove('hidden');
                            newCommentForm.reset();
                            socket.emit('new_comment', {
                                post_id: postId,
                                username: data.username,
                                content: content,
                                created_at: data.created_at
                            });
                        } else {
                            console.error('Failed to add comment:', data.message);
                        }
                    })
                    .catch(error => console.error('Error adding comment:', error));
            });

            // Загрузить последний комментарий для нового поста
            fetch(`/get_comments/${data.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.comments.length > 0) {
                        const latestComment = data.comments[data.comments.length - 1];
                        const latestCommentDiv = document.getElementById(`latest-comment-${data.id}`);
                        latestCommentDiv.innerHTML = `
                            <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${latestComment.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${latestComment.created_at})</span></p>
                            <p class="text-gray-700 dark:text-gray-300">${latestComment.content}</p>`;
                        latestCommentDiv.classList.remove('hidden');
                    }
                })
                .catch(error => console.error('Error loading latest comment:', error));
        });

        // Обработка нового запроса на дружбу
        socket.on('new_friend_request', function(data) {
            console.log('New friend request received:', data);
            const friendRequestsList = document.querySelector('.friend-requests');
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700';
            li.setAttribute('data-sender-id', data.sender_id);
            li.innerHTML = `
                <span class="font-medium text-gray-700 dark:text-gray-300">${data.sender_username}</span>
                <div class="flex gap-2">
                    <form action="/accept_friend/${data.sender_id}" method="POST" class="inline">
                        <button type="submit" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition min-h-12">Accept</button>
                    </form>
                    <form action="/reject_friend/${data.sender_id}" method="POST" class="inline">
                        <button type="submit" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 hover:scale-105 transition min-h-12">Reject</button>
                    </form>
                </div>
            `;
            friendRequestsList.insertBefore(li, friendRequestsList.firstChild);
            if (friendRequestsList.querySelector('p')) {
                friendRequestsList.querySelector('p').remove();
            }
        });

        // Обработка обновления реакций на пост
        socket.on('post_reaction_updated', function(data) {
            console.log('Post reaction updated:', data);
            const postDiv = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
            if (postDiv) {
                const likeButton = postDiv.querySelector('form[action^="/like_post"] button');
                const dislikeButton = postDiv.querySelector('form[action^="/dislike_post"] button');
                const likeSpan = postDiv.querySelector('.flex span:nth-child(2)');
                const dislikeSpan = postDiv.querySelector('.flex span:nth-child(4)');

                likeSpan.textContent = `${data.likes} likes`;
                dislikeSpan.textContent = `${data.dislikes} dislikes`;

                if (data.user_id === userId) {
                    likeButton.textContent = data.user_reaction === 'like' ? 'Unlike' : 'Like';
                    dislikeButton.textContent = data.user_reaction === 'dislike' ? 'Undislike' : 'Dislike';
                }
            }
        });

        // Управление комментариями
        document.querySelectorAll('.comment-btn').forEach(button => {
            button.addEventListener('click', () => {
                const postId = button.getAttribute('data-post-id');
                const commentsSection = document.getElementById(`comments-${postId}`);
                const commentsList = commentsSection.querySelector('.comments-list');

                // Показать/скрыть секцию комментариев
                commentsSection.classList.toggle('hidden');

                // Загрузить комментарии при первом открытии
                if (!commentsSection.classList.contains('hidden') && !commentsList.dataset.loaded) {
                    fetch(`/get_comments/${postId}`)
                        .then(response => response.json())
                        .then(data => {
                            commentsList.innerHTML = '';
                            data.comments.forEach(comment => {
                                const commentDiv = document.createElement('div');
                                commentDiv.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                                commentDiv.innerHTML = `
                                    <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${comment.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${comment.created_at})</span></p>
                                    <p class="text-gray-700 dark:text-gray-300">${comment.content}</p>`;
                                commentsList.appendChild(commentDiv);
                            });
                            commentsList.dataset.loaded = 'true';
                        })
                        .catch(error => console.error('Error loading comments:', error));
                }
            });
        });

        // Обработка отправки комментария
        document.querySelectorAll('.comment-form').forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const postId = form.getAttribute('data-post-id');
                const content = form.querySelector('textarea').value;

                fetch('/add_comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ post_id: postId, content: content }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const commentsList = form.previousElementSibling;
                            const commentDiv = document.createElement('div');
                            commentDiv.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                            commentDiv.innerHTML = `
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${data.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${data.created_at})</span></p>
                                <p class="text-gray-700 dark:text-gray-300">${content}</p>`;
                            commentsList.appendChild(commentDiv);
                            // Обновить последний комментарий
                            const latestCommentDiv = document.getElementById(`latest-comment-${postId}`);
                            latestCommentDiv.innerHTML = commentDiv.innerHTML;
                            latestCommentDiv.classList.remove('hidden');
                            form.reset();
                            // Уведомить других пользователей через SocketIO
                            socket.emit('new_comment', {
                                post_id: postId,
                                username: data.username,
                                content: content,
                                created_at: data.created_at
                            });
                        } else {
                            console.error('Failed to add comment:', data.message);
                        }
                    })
                    .catch(error => console.error('Error adding comment:', error));
            });
        });

        // Получение новых комментариев в реальном времени
        socket.on('new_comment', (data) => {
            const commentsSection = document.getElementById(`comments-${data.post_id}`);
            const commentsList = commentsSection.querySelector('.comments-list');
            if (commentsList && !commentsSection.classList.contains('hidden')) {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                commentDiv.innerHTML = `
                    <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${data.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${data.created_at})</span></p>
                    <p class="text-gray-700 dark:text-gray-300">${data.content}</p>`;
                commentsList.appendChild(commentDiv);
            }
            // Обновить последний комментарий
            const latestCommentDiv = document.getElementById(`latest-comment-${data.post_id}`);
            latestCommentDiv.innerHTML = `
                <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${data.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${data.created_at})</span></p>
                <p class="text-gray-700 dark:text-gray-300">${data.content}</p>`;
            latestCommentDiv.classList.remove('hidden');
        });

        // Переключение темы
        const themeToggleButton = document.getElementById('theme-toggle') || { addEventListener: () => {} };
        const body = document.body;
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            body.classList.add('dark');
            themeToggleButton.textContent = 'Switch to Light Theme';
        } else {
            body.classList.remove('dark');
            themeToggleButton.textContent = 'Switch to Dark Theme';
        }
        themeToggleButton.addEventListener('click', () => {
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                themeToggleButton.textContent = 'Switch to Dark Theme';
            } else {
                body.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                themeToggleButton.textContent = 'Switch to Light Theme';
            }
        });

        // Переключение скрытых постов
        const togglePosts = document.getElementById('toggle-posts');
        const hiddenPosts = document.getElementById('hidden-posts');
        if (togglePosts) {
            togglePosts.addEventListener('click', () => {
                if (hiddenPosts.style.display === 'none' || hiddenPosts.style.display === '') {
                    hiddenPosts.style.display = 'block';
                    togglePosts.textContent = 'Show fewer posts';
                } else {
                    hiddenPosts.style.display = 'none';
                    togglePosts.textContent = 'Show more posts';
                }
            });
        }
    </script>
</body>
</html>
